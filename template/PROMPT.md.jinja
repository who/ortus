# Ralph Wiggum Loop Prompt

Read @AGENTS.md for session rules and landing-the-plane protocol.
Read @activity.md for what was completed in the last iteration.

## Your Task

1. **Check Status**: Run `bd ready --assignee ralph` to see issues assigned to you with no blockers
2. **Select One Issue**: Pick the highest-priority issue from ready work
3. **Claim It**: Run `bd update <id> --status=in_progress`
4. **Implement**: Make the code changes described in the issue
5. **Verify**: Run tests, linting, or other verification appropriate to your project
6. **Complete**: Run `bd close <id> --reason="<brief summary>"`
7. **Epic Ceremony**: Check if this completes an epic (see Epic Closure Ceremony below)
8. **Log Progress**: Update activity.md with dated entry
9. **Commit**: Stage and commit your changes with descriptive message
10. **Push**: Run `git pull --rebase && bd sync && git push` to preserve work

## Verification Methods

{%- if language == 'python' %}

### For Tests
```bash
{%- if package_manager == 'uv' %}
uv run pytest tests/ -v
{%- else %}
pytest tests/ -v
{%- endif %}
```

### For Linting
```bash
{%- if package_manager == 'uv' %}
uv run ruff check .
uv run ruff format --check .
{%- else %}
ruff check .
ruff format --check .
{%- endif %}
```

### For Type Checking
```bash
{%- if package_manager == 'uv' %}
uv run mypy src/
{%- else %}
mypy src/
{%- endif %}
```

{%- elif language == 'typescript' %}

### For Tests
```bash
{{ package_manager }} test
```

### For Linting
```bash
{{ package_manager }} run lint
```

### For Type Checking
```bash
npx tsc --noEmit
```

{%- elif language == 'go' %}

### For Tests
```bash
go test ./...
```

### For Linting
```bash
golangci-lint run
```

### For Formatting
```bash
go fmt ./...
```

{%- elif language == 'rust' %}

### For Tests
```bash
cargo test
```

### For Linting
```bash
cargo clippy
```

### For Formatting
```bash
cargo fmt --check
```

{%- else %}

<!-- TODO: Add project-specific verification commands -->

{%- endif %}

## Epic Closure Ceremony

After closing a task, **automatically** check if it was part of an epic that is now complete.

### 1. Detect Parent Epic

Immediately after running `bd close <task-id>`, run:

```bash
bd show <task-id> --json
```

Parse the JSON output to find the parent:
- Look for the `"depends_on"` array - these are issues this task depends on
- A parent epic/feature is an issue in `depends_on` with `issue_type` of "epic" or "feature"

If no parent epic/feature found, **skip the ceremony** and continue to activity.md logging.

### 2. Check Epic Completion Status

If a parent epic/feature was found:

```bash
bd show <parent-id> --json
```

Parse the JSON to check completion status:
- Look at the `"blocks"` array - these are child tasks that depend on the parent
- For each child issue ID, check if its status is "closed"
- If **ALL** children are closed, the epic is ready for ceremony
- If any children are still open, **skip the ceremony** - more work remains

### 3. Quality Gate Audit

Before closing the epic, verify all acceptance criteria are met:

1. Read the epic's description and identify acceptance criteria
2. For each criterion, verify there's a completed task that addresses it
3. Check that verification was performed (tests, manual testing, etc.)

If any criteria are NOT covered:
```bash
# Create missing tasks
bd create --title="<missing work>" --type=task --assignee=ralph
bd dep add <new-task-id> <epic-id>
# Do NOT close the epic yet
```

### 4. Write Retrospective

Add a retrospective entry to activity.md with:
- **Key decisions**: Important architectural or design choices made
- **Learnings**: What worked well, what was challenging
- **Follow-up**: Any tech debt or improvements deferred for later

### 5. Close Epic

Only after all criteria are verified:
```bash
bd close <epic-id> --reason="All acceptance criteria met: <brief summary of what was delivered>"
```

### When to Skip

Skip the ceremony if:
- The task has no parent epic
- The parent epic still has other open tasks

## Important Rules

- **One issue per iteration** - Do not work on multiple issues
- **No partial work** - Either complete the issue fully or don't start it
- **Update activity.md** - Record what you did with timestamp
- **Run quality checks** - Always run linting/tests before committing
- **Descriptive commits** - Include issue ID in commit message

## README Maintenance

After implementing a major feature:
1. Check if README.md exists
2. If not, create initial README with:
   - Project name and description
   - Installation/setup instructions
   - Usage documentation for implemented features
   - Basic examples
3. If README exists, update it with:
   - New feature documentation
   - Updated usage examples
   - Keep existing user-edited sections intact

## Completion Signal

When you have completed ONE issue successfully, output:

```
<promise>COMPLETE</promise>
```

If you encounter a blocker that prevents completion, document it in activity.md and output:

```
<promise>BLOCKED</promise>
```

## Dependencies

Issues may have dependencies. Check with:
```bash
bd show <id>  # Shows dependencies in output
bd dep tree <id>  # Visual dependency tree
```

Only work on issues that have no unresolved blockers (i.e., issues shown by `bd ready --assignee ralph`).

## Project-Specific Notes

{%- if language == 'python' and package_manager == 'uv' %}
- Use `uv run` for all Python commands
{%- endif %}
{%- if framework == 'fastapi' %}
- API runs on port 8000 by default
{%- endif %}

<!-- TODO: Add any additional project-specific notes here -->
